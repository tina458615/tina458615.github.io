<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯é ˜èˆªè€…ï¼šé£›è¡Œæ—¥è¨˜ - éŠæˆ²åŸå‹</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Production versions for stability) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #1a202c;
            color: #fff;
            overflow: hidden; /* Prevent scrolling for app-like feel */
            user-select: none;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1); 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3); 
            border-radius: 4px;
        }

        .pixel-corners {
            clip-path: polygon(
                0px 10px, 10px 0px, 
                calc(100% - 10px) 0px, 100% 10px, 
                100% calc(100% - 10px), calc(100% - 10px) 100%, 
                10px 100%, 0px calc(100% - 10px)
            );
        }

        @keyframes progress-stripes {
            from { background-position: 1rem 0; }
            to { background-position: 0 0; }
        }
        
        .animate-stripes {
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
            animation: progress-stripes 1s linear infinite;
        }
    </style>
</head>
<body>

    <div id="root" class="app-container h-screen w-screen bg-slate-900 overflow-hidden relative"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- Inline Icons ---
        const Icons = {
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Rocket: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>,
            Leaf: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>,
            ArrowLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Play: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            TrendingUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Coins: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82"/></svg>,
            Factory: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Timer: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        };

        const { Settings, Rocket, Leaf, ArrowLeft, Play, Info, CheckCircle, AlertTriangle, TrendingUp, Coins, Factory, X, Star, Timer } = Icons;

        // --- Game Config Constants ---
        const PARTS_DATA = {
            engine: [
                { id: 'e1', name: 'è‡ªç„¶å‹•åŠ›å¼•æ“', type: 'natural', cost: 100, carbon: 5000, time: 'æ…¢', duration: 10, desc: 'ä½ç¢³ï¼ŒèŠ±è²»æœ€å°‘ï¼Œä½†å»ºé€ è€—æ™‚ã€‚' }, 
                { id: 'e2', name: 'æ ¸èçˆ†ç™¼å¼•æ“', type: 'luxury', cost: 500, carbon: 15000, time: 'æ¥µå¿«', duration: 3, desc: 'é«˜ç¢³ï¼ŒèŠ±è²»æ˜‚è²´ï¼Œä½†å»ºé€ æœ€å¿«ã€‚' }, 
                { id: 'e3', name: 'åé‡åŠ›å¥‡ç•°é»å¼•æ“', type: 'future', cost: 300, carbon: 2000, time: 'å¿«', duration: 6, desc: 'éœ€æŠ€è¡“å‡ç´šã€‚ä½ç¢³ä¸”å»ºé€ å¿«é€Ÿã€‚', locked: true, requiredTechLevel: 1 } 
            ],
            body: [
                { id: 'b1', name: 'è¼•æœ¨æµç·šæ©Ÿèº«', type: 'natural', cost: 100, carbon: 6000, time: 'æ…¢', duration: 10, desc: 'ç’°ä¿æè³ªï¼Œè¼•ç›ˆä½†å»ºé€ è€—æ™‚ã€‚' }, 
                { id: 'b2', name: 'éˆ¦é‹¼é‡è£æ©Ÿèº«', type: 'luxury', cost: 600, carbon: 18000, time: 'æ¥µå¿«', duration: 3, desc: 'å …å›ºä½†ç¢³æ’é«˜ï¼Œå»ºé€ æœ€å¿«ã€‚' }, 
                { id: 'b3', name: 'é‡å­å¥ˆç±³ç·¨ç¹”æ©Ÿèº«', type: 'future', cost: 400, carbon: 3000, time: 'å¿«', duration: 6, desc: 'éœ€æŠ€è¡“å‡ç´šã€‚ä½ç¢³ä¸”å»ºé€ å¿«é€Ÿã€‚', locked: true, requiredTechLevel: 3 } 
            ],
            wing: [
                { id: 'w1', name: 'ä»¿ç”Ÿç¾½ç¿¼', type: 'natural', cost: 80, carbon: 4000, time: 'æ…¢', duration: 10, desc: 'æ¨¡ä»¿é³¥é¡é£›è¡Œï¼Œå»ºé€ è€—æ™‚ã€‚' }, 
                { id: 'w2', name: 'å™´å°„å¾Œæ ç¿¼', type: 'luxury', cost: 400, carbon: 12000, time: 'æ¥µå¿«', duration: 3, desc: 'è¿½æ±‚é€Ÿåº¦çš„è¨­è¨ˆï¼Œå»ºé€ æœ€å¿«ã€‚' }, 
                { id: 'w3', name: 'å…‰å­å¸†å¤ªé™½èƒ½ç¿¼', type: 'future', cost: 250, carbon: 1500, time: 'å¿«', duration: 6, desc: 'éœ€æŠ€è¡“å‡ç´šã€‚ä½ç¢³ä¸”å»ºé€ å¿«é€Ÿã€‚', locked: true, requiredTechLevel: 2 } 
            ],
            decoration: [
                { id: 'd1', name: 'è—¤è”“èŠ±ç’°', type: 'natural', cost: 50, carbon: 500, time: 'æ…¢', duration: 10, desc: 'é»ç¶´è‡ªç„¶çš„æ°£æ¯ã€‚' }, 
                { id: 'd2', name: 'éœ“è™¹ç‡ˆæ¢', type: 'luxury', cost: 200, carbon: 2000, time: 'æ¥µå¿«', duration: 3, desc: 'çµ¢éº—å¥ªç›®çš„è£é£¾ã€‚' }, 
                { id: 'd3', name: 'å…¨æ¯æŠ•å½±å„€', type: 'future', cost: 150, carbon: 100, time: 'å¿«', duration: 6, desc: 'ç§‘æŠ€æ„Ÿçš„è±¡å¾µã€‚' } 
            ]
        };

        const TECH_UPGRADES = [
            { level: 1, name: "èƒ½æºå…ƒä»¶æŠ€è¡“", cost: 1000, desc: "è§£é–æœªä¾†å¼•æ“" },
            { level: 2, name: "å¤ªé™½èƒ½æŠ€è¡“", cost: 1500, desc: "è§£é–æœªä¾†æ©Ÿç¿¼" },
            { level: 3, name: "æ™ºæ…§é›»ç¶²æŠ€è¡“", cost: 2000, desc: "è§£é–æœªä¾†æ©Ÿèº«" }
        ];

        const CARBON_FEE_RATE = 0.5; 
        const INITIAL_CARBON_LIMIT = 25000;
        const ECO_ACTION_DURATION = 5; 
        const MARKET_BUNDLE_SIZE = 5000; // Size of credit bundle
        
        // Fixed Market Prices
        const FIXED_BUY_PRICE = 500;
        const FIXED_SELL_PRICE = 300;

        // --- Components ---

        const ShipPreview = ({ parts }) => {
            return (
                <div className="relative w-64 h-64 flex items-center justify-center animate-bounce-slow">
                    {/* Wings (Back) */}
                    {parts.wing && (
                        <div className={`absolute w-48 h-12 rounded-full transform transition-all duration-500
                            ${parts.wing.type === 'natural' ? 'bg-green-600 rotate-12' : 
                              parts.wing.type === 'luxury' ? 'bg-red-600 -rotate-6' : 'bg-cyan-400 opacity-80'}`} 
                        />
                    )}
                    
                    {/* Engine (Bottom/Back) */}
                    {parts.engine && (
                        <div className={`absolute bottom-16 w-16 h-16 rounded-b-lg transform transition-all duration-500
                            ${parts.engine.type === 'natural' ? 'bg-amber-700' : 
                              parts.engine.type === 'luxury' ? 'bg-orange-600 animate-pulse' : 'bg-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.8)]'}`} 
                        />
                    )}

                    {/* Body (Front) */}
                    {parts.body ? (
                        <div className={`absolute w-24 h-40 rounded-full border-4 border-slate-800 z-10 transform transition-all duration-500 flex items-center justify-center
                            ${parts.body.type === 'natural' ? 'bg-amber-100' : 
                              parts.body.type === 'luxury' ? 'bg-slate-300' : 'bg-white/20 backdrop-blur-md border-cyan-400'}`}
                        >
                            <div className="text-xs text-black font-bold opacity-50">é§•é§›è‰™</div>
                        </div>
                    ) : (
                        <div className="w-24 h-40 border-2 border-dashed border-white/30 rounded-full flex items-center justify-center text-xs text-white/30">
                            æœªå®‰è£
                        </div>
                    )}

                    {/* Decoration (Top/Overlay) */}
                    {parts.decoration && (
                        <div className="absolute top-10 right-10 text-4xl animate-pulse z-20 drop-shadow-lg">
                            {parts.decoration.type === 'natural' ? 'ğŸŒ¿' : 
                             parts.decoration.type === 'luxury' ? 'ğŸ’' : 'ğŸ’ '}
                        </div>
                    )}
                </div>
            );
        };

        const ConstructionOverlay = ({ task }) => {
            if (!task) return null;
            
            const progress = ((task.totalTime - task.timeLeft) / task.totalTime) * 100;

            return (
                <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center p-4">
                    <div className="bg-slate-800 border-2 border-slate-600 rounded-2xl p-8 w-full max-w-md shadow-2xl relative pixel-corners">
                        <h3 className="text-2xl font-bold text-yellow-400 mb-6 text-center flex items-center justify-center gap-3">
                            <Timer className="animate-spin-slow" />
                            {task.type === 'BUILD' ? 'å»ºé€ ä¸­...' : 'åŸ·è¡Œä¸­...'}
                        </h3>
                        
                        <div className="text-center text-white mb-2 font-bold text-lg">{task.name}</div>
                        <div className="text-center text-gray-400 mb-6 text-sm">å‰©é¤˜æ™‚é–“: {Math.ceil(task.timeLeft)} ç§’</div>
                        
                        <div className="w-full h-4 bg-slate-900 rounded-full overflow-hidden border border-slate-700">
                            <div 
                                className="h-full bg-gradient-to-r from-blue-500 to-green-400 animate-stripes transition-all duration-100 ease-linear"
                                style={{ width: `${progress}%` }}
                            ></div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            // State
            const [screen, setScreen] = useState('START'); // START, TUTORIAL, MODE_SELECT, RESEARCH...
            const [money, setMoney] = useState(500); // Default placeholder
            const [carbonLimit, setCarbonLimit] = useState(INITIAL_CARBON_LIMIT); 
            const [parts, setParts] = useState({ engine: null, body: null, wing: null, decoration: null });
            const [techLevel, setTechLevel] = useState(0); 
            const [hasInvestedInMarket, setHasInvestedInMarket] = useState(false); 
            const [selectedCategory, setSelectedCategory] = useState(null);
            
            // Task State
            const [currentTask, setCurrentTask] = useState(null);

            // Computed State
            const totalCarbon = useMemo(() => {
                return (parts.engine?.carbon || 0) + (parts.body?.carbon || 0) + (parts.wing?.carbon || 0) + (parts.decoration?.carbon || 0);
            }, [parts]);

            const isShipComplete = parts.engine && parts.body && parts.wing; 
            const excessCarbon = Math.max(0, totalCarbon - carbonLimit);

            // Money Loop
            useEffect(() => {
                const interval = setInterval(() => {
                    // Money Growth
                    if (screen !== 'START' && screen !== 'TUTORIAL' && screen !== 'MODE_SELECT' && screen !== 'ENDING' && !currentTask) {
                        setMoney(m => m + 10); 
                    }
                }, 2000); 
                return () => clearInterval(interval);
            }, [screen, currentTask]);

            // Task Timer Loop
            useEffect(() => {
                if (!currentTask) return;

                const timer = setInterval(() => {
                    setCurrentTask(prev => {
                        if (!prev) return null;
                        const newTimeLeft = prev.timeLeft - 0.1;
                        if (newTimeLeft <= 0) {
                            clearInterval(timer);
                            prev.onComplete();
                            return null;
                        }
                        return { ...prev, timeLeft: newTimeLeft };
                    });
                }, 100);

                return () => clearInterval(timer);
            }, [currentTask]);

            // Handlers
            const handleStartGame = () => setScreen('TUTORIAL');
            const handleSkipTutorial = () => setScreen('MODE_SELECT'); // Go to mode select instead of research directly
            
            const handleSelectMode = (initialFunds) => {
                setMoney(initialFunds);
                setScreen('RESEARCH');
            };

            const handleSelectCategory = (category) => {
                setSelectedCategory(category);
                setScreen('PART_SELECT');
            };

            const handleBuyPart = (category, part) => {
                const currentPartCarbon = parts[category]?.carbon || 0;
                const newTotalCarbon = totalCarbon - currentPartCarbon + part.carbon;
                
                const newExcess = Math.max(0, newTotalCarbon - carbonLimit);
                const currentExcess = Math.max(0, totalCarbon - carbonLimit);
                const marginalExcessIncrease = Math.max(0, newExcess - currentExcess);
                
                let immediateFee = 0;
                if (newTotalCarbon > carbonLimit) {
                    immediateFee = Math.ceil(marginalExcessIncrease * CARBON_FEE_RATE);
                }

                const totalCost = part.cost + immediateFee;

                if (money >= totalCost) {
                    setMoney(m => m - totalCost);
                    
                    setCurrentTask({
                        type: 'BUILD',
                        name: `å®‰è£ ${part.name}`,
                        totalTime: part.duration,
                        timeLeft: part.duration,
                        onComplete: () => {
                            setParts(p => ({ ...p, [category]: part }));
                            setScreen('RESEARCH');
                            if (immediateFee > 0) {
                                alert(`å®‰è£å®Œæˆï¼\nç¸½ç¢³æ’: ${newTotalCarbon} / ${carbonLimit}\nå·²å¾µæ”¶ç¢³è²» $${immediateFee} (å› è¶…éæ’æ”¾ä¸Šé™)`);
                            }
                        }
                    });

                } else {
                    alert(`è³‡é‡‘ä¸è¶³ï¼éœ€è¦ $${totalCost} (å«é ä¼°ç¢³è²» $${immediateFee})`);
                }
            };

            const handleUpgradeTech = () => {
                if (!hasInvestedInMarket) {
                    alert("è«‹å…ˆè‡³å¸‚é›†ã€ŒæŠ•è³‡æ¸›ç¢³æŠ€è¡“ã€ä»¥è§£é–ç ”ç™¼åŠŸèƒ½ï¼");
                    return;
                }

                if (techLevel >= 3) return;

                const nextUpgrade = TECH_UPGRADES[techLevel];
                if (money < nextUpgrade.cost) {
                    alert(`è³‡é‡‘ä¸è¶³ (éœ€è¦ $${nextUpgrade.cost})`);
                    return;
                }

                setMoney(m => m - nextUpgrade.cost);
                setTechLevel(prev => prev + 1);
                alert(`å‡ç´šæˆåŠŸï¼${nextUpgrade.desc}`);
            };

            const handleMarketAction = (action) => {
                if (action === 'BUY_LIMIT') { 
                    if (money >= FIXED_BUY_PRICE) {
                        setMoney(m => m - FIXED_BUY_PRICE);
                        setCarbonLimit(c => c + MARKET_BUNDLE_SIZE); 
                    } else {
                        alert(`è³‡é‡‘ä¸è¶³ (éœ€è¦ $${FIXED_BUY_PRICE})`);
                    }
                } else if (action === 'SELL_LIMIT') { 
                    if (carbonLimit >= MARKET_BUNDLE_SIZE) {
                        setMoney(m => m + FIXED_SELL_PRICE);
                        setCarbonLimit(c => c - MARKET_BUNDLE_SIZE);
                    } else {
                        alert("ç¢³æ¬Šé¡åº¦ä¸è¶³ä»¥å‡ºå”®");
                    }
                } else if (action === 'ECO_ACTION') { 
                    // Start Eco Action Task
                    setCurrentTask({
                        type: 'MARKET',
                        name: 'é€²è¡Œç’°ä¿è¡Œå‹•',
                        totalTime: ECO_ACTION_DURATION,
                        timeLeft: ECO_ACTION_DURATION,
                        onComplete: () => {
                            setCarbonLimit(c => c + 1000);
                            alert("è¡Œå‹•å®Œæˆï¼ç¢³æ’æ”¾ä¸Šé™å·²å¢åŠ  1000ã€‚");
                        }
                    });
                } else if (action === 'INVEST_TECH') { 
                    if (money >= 1000) {
                        setMoney(m => m - 1000);
                        setHasInvestedInMarket(true);
                        setCarbonLimit(c => c + 3000); 
                        alert("æŠ•è³‡æˆåŠŸï¼å·²å¢åŠ ç¢³æ’æ”¾ä¸Šé™ï¼Œä¸¦è§£é–ç ”ç™¼ä¸­å¿ƒæŠ€è¡“å‡ç´šæ¬Šé™ã€‚");
                    } else {
                        alert("è³‡é‡‘ä¸è¶³ (éœ€è¦ $1000)");
                    }
                }
            };

            const handleLaunch = () => {
                setScreen('ENDING');
            };

            const handleReset = () => {
                // Reset to start, specific money will be set in MODE_SELECT
                setCarbonLimit(INITIAL_CARBON_LIMIT);
                setParts({ engine: null, body: null, wing: null, decoration: null });
                setTechLevel(0);
                setHasInvestedInMarket(false);
                setScreen('START');
            };

            // --- Sub-Screens ---

            if (screen === 'START') {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 text-white relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-full opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                        <h1 className="text-6xl font-black mb-4 tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400 drop-shadow-lg">
                            é›²ç«¯é ˜èˆªè€…ï¼šé£›è¡Œæ—¥è¨˜
                        </h1>
                        <p className="text-xl mb-12 text-gray-300">ç¢³è²»é£›è¡Œå™¨è¨­è¨ˆè¨ˆç•«</p>
                        <div className="flex gap-6">
                            <button onClick={handleStartGame} className="px-8 py-4 bg-green-500 hover:bg-green-600 text-black font-bold rounded-lg transform hover:scale-105 transition-all shadow-[0_0_20px_rgba(34,197,94,0.5)] flex items-center gap-2">
                                <Play size={24} /> é–‹å§‹ç ”ç™¼
                            </button>
                            <button className="px-8 py-4 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg border border-slate-500 flex items-center gap-2">
                                <Settings size={24} /> è¨­å®š
                            </button>
                        </div>
                    </div>
                );
            }

            if (screen === 'TUTORIAL') {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center bg-slate-800 p-8">
                        <div className="max-w-4xl w-full bg-slate-700 rounded-2xl p-8 shadow-2xl border border-slate-600 flex flex-col gap-6">
                            <h2 className="text-3xl font-bold text-yellow-400 mb-2">æ–°æ‰‹å¼•å°ï¼šç¢³è²»èˆ‡ç¢³æ¬Š</h2>
                            <div className="grid grid-cols-2 gap-8 text-lg">
                                <div className="bg-slate-800 p-6 rounded-xl border border-red-500/30">
                                    <h3 className="text-red-400 font-bold mb-2 flex items-center gap-2"><AlertTriangle/> ç¢³è²» (Carbon Fee)</h3>
                                    <p className="text-gray-300 text-sm">
                                        ç•¶ä½ çš„é£›è¡Œå™¨ç¢³æ’æ”¾ç¸½é‡ <span className="text-white font-bold">è¶…é</span> è¨­å®šçš„ä¸Šé™ï¼ˆ2.5è¬å…¬å™¸ï¼‰æ™‚ï¼Œ
                                        å¿…é ˆæ”¯ä»˜é¡å¤–çš„ç¢³è²»ä½œç‚ºä»£åƒ¹ã€‚
                                    </p>
                                </div>
                                <div className="bg-slate-800 p-6 rounded-xl border border-green-500/30">
                                    <h3 className="text-green-400 font-bold mb-2 flex items-center gap-2"><CheckCircle/> ç¢³æ’æ”¾ç¸½é‡ (Allowance)</h3>
                                    <p className="text-gray-300 text-sm">
                                        é€™æ˜¯ä½ è¢«å…è¨±çš„æ’æ”¾é¡åº¦ã€‚ä½ å¯ä»¥é€é <span className="text-white font-bold">å¸‚é›†</span> 
                                        æŠ•è³‡æ¸›ç¢³æŠ€è¡“æˆ–è³¼è²·é¡åº¦ï¼Œä»¥é¿å…è¢«å¾µæ”¶é«˜é¡ç¢³è²»ã€‚
                                    </p>
                                </div>
                            </div>
                            <div className="flex justify-end mt-4">
                                <button onClick={handleSkipTutorial} className="px-6 py-3 bg-blue-500 hover:bg-blue-600 rounded-lg font-bold text-white flex items-center gap-2">
                                    äº†è§£ï¼Œé€²å…¥ç ”ç™¼ä¸­å¿ƒ <ArrowLeft className="rotate-180"/>
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'MODE_SELECT') {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center bg-slate-900 p-8 relative">
                        <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black z-0"></div>
                        <h2 className="text-4xl font-bold text-white mb-12 z-10">è«‹é¸æ“‡éŠæˆ²æ¨¡å¼</h2>
                        
                        <div className="flex gap-8 z-10">
                            {/* Standard Mode Card */}
                            <div className="w-80 bg-slate-800 border-2 border-slate-600 rounded-2xl p-8 flex flex-col items-center hover:border-green-400 transition-all hover:scale-105 shadow-xl group">
                                <div className="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mb-6 group-hover:bg-green-900 transition-colors">
                                    <Leaf size={32} className="text-green-400" />
                                </div>
                                <h3 className="text-2xl font-bold text-white mb-2">ä¸€èˆ¬æŒ‘æˆ°</h3>
                                <div className="text-3xl font-mono text-yellow-400 mb-6">$500</div>
                                <p className="text-gray-400 text-sm text-center mb-8">
                                    æ¨™æº–çš„è³‡é‡‘èµ·æ­¥ï¼Œé«”é©—å®Œæ•´çš„ç¶“ç‡Ÿèˆ‡ç ”ç™¼æŒ‘æˆ°ã€‚é©åˆæƒ³è¦å¾ªåºæ¼¸é€²çš„ç©å®¶ã€‚
                                </p>
                                <button 
                                    onClick={() => handleSelectMode(500)}
                                    className="w-full py-3 bg-slate-700 hover:bg-green-600 text-white font-bold rounded-lg transition-colors"
                                >
                                    é¸æ“‡æ­¤æ¨¡å¼
                                </button>
                            </div>

                            {/* Test Mode Card */}
                            <div className="w-80 bg-slate-800 border-2 border-slate-600 rounded-2xl p-8 flex flex-col items-center hover:border-blue-400 transition-all hover:scale-105 shadow-xl group">
                                <div className="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mb-6 group-hover:bg-blue-900 transition-colors">
                                    <Rocket size={32} className="text-blue-400" />
                                </div>
                                <h3 className="text-2xl font-bold text-white mb-2">æ¸¬è©¦é«”é©—</h3>
                                <div className="text-3xl font-mono text-yellow-400 mb-6">$5,000</div>
                                <p className="text-gray-400 text-sm text-center mb-8">
                                    æ“æœ‰å……è£•çš„è³‡é‡‘ï¼Œå¯ä»¥å¿«é€Ÿè§£é–æ‰€æœ‰ç§‘æŠ€èˆ‡éƒ¨ä»¶ã€‚é©åˆé–‹ç™¼æ¸¬è©¦æˆ–å¿«é€Ÿé«”é©—ã€‚
                                </p>
                                <button 
                                    onClick={() => handleSelectMode(5000)}
                                    className="w-full py-3 bg-slate-700 hover:bg-blue-600 text-white font-bold rounded-lg transition-colors"
                                >
                                    é¸æ“‡æ­¤æ¨¡å¼
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'RESEARCH') {
                const isMaxTech = techLevel >= 3;
                const nextUpgrade = isMaxTech ? null : TECH_UPGRADES[techLevel];
                const canAfford = nextUpgrade && money >= nextUpgrade.cost;

                return (
                    <div className="w-full h-full flex bg-slate-900 text-white relative">
                        {currentTask && <ConstructionOverlay task={currentTask} />}
                        <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black z-0"></div>

                        <div className="w-1/4 h-full z-10 p-4 flex flex-col gap-4 bg-slate-900/80 border-r border-slate-700 backdrop-blur">
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-600 shadow-lg">
                                <h3 className="text-gray-400 text-sm mb-1 uppercase tracking-wider">Project Funds</h3>
                                <div className="text-3xl font-mono text-yellow-400 flex items-center gap-2">
                                    <Coins className="text-yellow-500" /> ${money}
                                </div>
                            </div>

                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-600 shadow-lg space-y-2">
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-400 text-sm">ç•¶å‰ç¢³æ’</span>
                                    <span className={`text-xl font-bold ${excessCarbon > 0 ? 'text-red-500 animate-pulse' : 'text-white'}`}>{totalCarbon}</span>
                                </div>
                                <div className="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div className={`h-full ${excessCarbon > 0 ? 'bg-red-500' : 'bg-green-500'}`} style={{ width: `${Math.min(100, (totalCarbon/carbonLimit)*100)}%` }}></div>
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-gray-500">æ’æ”¾ä¸Šé™</span>
                                    <span className="text-green-400">{carbonLimit}</span>
                                </div>
                                {excessCarbon > 0 && (
                                    <div className="text-xs text-red-400 mt-1 bg-red-900/30 p-1 rounded">
                                        âš  è¶…æ¨™ {excessCarbon} å–®ä½ï¼Œéœ€ä»˜é¡å¤–ç¢³è²»
                                    </div>
                                )}
                            </div>

                            <div className="mt-auto space-y-2">
                                <button onClick={() => setScreen('MARKET')} className="w-full py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-bold flex items-center justify-center gap-2 transition-colors">
                                    <TrendingUp size={20}/> å¸‚é›†
                                </button>
                                
                                {!isMaxTech ? (
                                    <button 
                                        onClick={handleUpgradeTech} 
                                        disabled={!hasInvestedInMarket || (hasInvestedInMarket && !canAfford)}
                                        className={`w-full py-3 rounded-lg font-bold flex flex-col items-center justify-center gap-1 transition-colors border-2
                                        ${!hasInvestedInMarket 
                                            ? 'bg-slate-800 border-slate-600 text-gray-500' 
                                            : !canAfford
                                                ? 'bg-slate-800 border-red-500/50 text-red-400 cursor-not-allowed'
                                                : 'bg-transparent border-cyan-500 text-cyan-400 hover:bg-cyan-900/30'}`}
                                    >
                                        <div className="flex items-center gap-2">
                                            <Factory size={20}/> 
                                            {!hasInvestedInMarket ? "éœ€å…ˆè‡³å¸‚é›†æŠ•è³‡" : (nextUpgrade ? nextUpgrade.name : "å‡ç´š")}
                                        </div>
                                        {hasInvestedInMarket && nextUpgrade && (
                                            <div className="flex flex-col items-center">
                                                <span className={`text-xs ${canAfford ? 'opacity-70' : 'text-red-400 font-bold'}`}>
                                                    èŠ±è²» ${nextUpgrade.cost} {canAfford ? '' : '(ä¸è¶³)'}
                                                </span>
                                                <span className="text-[10px] opacity-50 text-cyan-200 mt-1">
                                                    (ç ”ç™¼é€²åº¦: {techLevel} / 3)
                                                </span>
                                            </div>
                                        )}
                                    </button>
                                ) : (
                                    <div className="w-full py-3 rounded-lg bg-cyan-900/30 border border-cyan-500 text-cyan-400 text-center font-bold flex flex-col items-center justify-center gap-1">
                                        <div className="flex items-center gap-2">
                                            <CheckCircle size={20} /> å®Œæˆæ‰€æœ‰å‡ç´š
                                        </div>
                                        <span className="text-[10px] opacity-70">(ç­‰ç´š 3 / 3)</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="flex-1 h-full z-10 relative flex flex-col items-center justify-center">
                             <div className="absolute top-8 text-2xl font-bold text-slate-500 tracking-[0.5em]">HANGAR 01</div>
                             <ShipPreview parts={parts} />
                             {isShipComplete ? (
                                <button onClick={handleLaunch} className="absolute bottom-8 px-12 py-4 bg-gradient-to-r from-orange-500 to-red-600 rounded-full font-black text-xl shadow-[0_0_30px_rgba(239,68,68,0.6)] animate-pulse hover:scale-110 transition-transform">
                                    æº–å‚™å‡ç©º LAUNCH
                                </button>
                             ) : (
                                <div className="absolute bottom-8 text-gray-500 flex items-center gap-2">
                                    <Info size={16}/> éœ€å®‰è£å¼•æ“ã€æ©Ÿèº«èˆ‡æ©Ÿç¿¼
                                </div>
                             )}
                        </div>

                        <div className="w-1/5 h-full z-10 bg-slate-900/80 border-l border-slate-700 p-4 flex flex-col gap-4 backdrop-blur">
                            <h3 className="text-gray-400 text-sm uppercase tracking-wider mb-2">éƒ¨ä»¶ç ”ç™¼</h3>
                            {[
                                { id: 'engine', label: 'å¼•æ“å‹•åŠ›', icon: Rocket },
                                { id: 'body', label: 'æ©Ÿèº«çµæ§‹', icon: Settings },
                                { id: 'wing', label: 'æ©Ÿç¿¼ç³»çµ±', icon: Leaf },
                                { id: 'decoration', label: 'è£é£¾å“', icon: Star }
                            ].map(cat => (
                                <button 
                                    key={cat.id}
                                    onClick={() => handleSelectCategory(cat.id)}
                                    className={`w-full p-4 rounded-xl border-2 flex items-center justify-between group transition-all
                                    ${parts[cat.id] 
                                        ? 'border-green-500 bg-green-500/10 text-green-400' 
                                        : 'border-slate-600 bg-slate-800 text-gray-300 hover:border-blue-400 hover:text-white'}`}
                                >
                                    <div className="flex items-center gap-3">
                                        <cat.icon size={20} />
                                        <div className="text-left">
                                            <div className="font-bold text-sm">{cat.label}</div>
                                            <div className="text-xs opacity-70">{parts[cat.id] ? parts[cat.id].name : (cat.id === 'decoration' ? 'å¯é¸' : 'å°šæœªç ”ç™¼')}</div>
                                        </div>
                                    </div>
                                    {parts[cat.id] && <CheckCircle size={16} />}
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (screen === 'PART_SELECT') {
                const categoryParts = PARTS_DATA[selectedCategory];
                let categoryName = 'éƒ¨ä»¶';
                if(selectedCategory === 'engine') categoryName = 'å¼•æ“';
                if(selectedCategory === 'body') categoryName = 'æ©Ÿèº«';
                if(selectedCategory === 'wing') categoryName = 'æ©Ÿç¿¼';
                if(selectedCategory === 'decoration') categoryName = 'è£é£¾å“';

                return (
                    <div className="w-full h-full bg-slate-900 p-8 flex flex-col items-center relative">
                        {currentTask && <ConstructionOverlay task={currentTask} />}
                        <button onClick={() => setScreen('RESEARCH')} className="absolute top-8 left-8 flex items-center gap-2 text-gray-400 hover:text-white">
                            <ArrowLeft /> è¿”å›ç ”ç™¼ä¸­å¿ƒ
                        </button>
                        
                        <h2 className="text-3xl font-bold mb-8 flex items-center gap-3">
                            é¸æ“‡{categoryName} <span className="text-sm font-normal text-gray-500 bg-slate-800 px-3 py-1 rounded">è³‡é‡‘: ${money}</span>
                        </h2>

                        <div className="flex gap-6 w-full max-w-6xl h-full pb-8">
                            {categoryParts.map(part => {
                                const isLocked = part.locked && (
                                    (part.requiredTechLevel === 1 && techLevel < 1) ||
                                    (part.requiredTechLevel === 2 && techLevel < 2) ||
                                    (part.requiredTechLevel === 3 && techLevel < 3)
                                );

                                const currentPartCarbon = parts[selectedCategory]?.carbon || 0;
                                const newTotal = totalCarbon - currentPartCarbon + part.carbon;
                                
                                const newExcess = Math.max(0, newTotal - carbonLimit);
                                const currentExcess = Math.max(0, totalCarbon - carbonLimit);
                                const marginalExcessIncrease = Math.max(0, newExcess - currentExcess);
                                
                                let fee = 0;
                                if (newTotal > carbonLimit) {
                                    fee = Math.ceil(marginalExcessIncrease * CARBON_FEE_RATE);
                                }

                                return (
                                    <div key={part.id} className={`flex-1 rounded-2xl p-6 border-2 flex flex-col relative overflow-hidden transition-all
                                        ${isLocked ? 'border-slate-700 bg-slate-800 opacity-60 grayscale' : 'border-slate-600 bg-slate-800 hover:border-blue-400 hover:shadow-xl hover:-translate-y-2'}`}>
                                        
                                        {isLocked && (
                                            <div className="absolute inset-0 z-20 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                                                <div className="text-center p-4">
                                                    <Factory className="mx-auto mb-2 text-gray-400" size={32} />
                                                    <span className="font-bold text-red-400 block mb-2">éœ€è¦æŠ€è¡“å‡ç´š</span>
                                                    <span className="text-xs text-gray-400">
                                                        {part.requiredTechLevel === 1 ? "éœ€: èƒ½æºå…ƒä»¶æŠ€è¡“" :
                                                         part.requiredTechLevel === 2 ? "éœ€: å¤ªé™½èƒ½æŠ€è¡“" : "éœ€: æ™ºæ…§é›»ç¶²æŠ€è¡“"}
                                                    </span>
                                                </div>
                                            </div>
                                        )}

                                        <div className="flex justify-between items-start mb-4">
                                            <div className={`text-xs font-bold px-2 py-1 rounded uppercase
                                                ${part.type === 'natural' ? 'bg-green-900 text-green-400' :
                                                  part.type === 'luxury' ? 'bg-orange-900 text-orange-400' : 'bg-cyan-900 text-cyan-400'}`}>
                                                {part.type === 'natural' ? 'è‡ªç„¶ç¾è§€' : part.type === 'luxury' ? 'è¯éº—é«˜ç´š' : 'æœªä¾†ç§‘æŠ€'}
                                            </div>
                                            <div className="text-yellow-400 font-mono font-bold">${part.cost}</div>
                                        </div>

                                        <h3 className="text-xl font-bold mb-2">{part.name}</h3>
                                        <p className="text-sm text-gray-400 mb-6 flex-1">{part.desc}</p>

                                        <div className="space-y-2 mb-6 text-sm">
                                            <div className="flex justify-between">
                                                <span>ç”¢ç”Ÿç¢³æ’</span>
                                                <span className={part.carbon > 6000 ? 'text-red-400' : 'text-green-400'}>{part.carbon}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span>å»ºé€ æ™‚é–“</span>
                                                <span>{part.time} ({part.duration}s)</span>
                                            </div>
                                            {fee > 0 && (
                                                <div className="flex justify-between text-red-400 font-bold border-t border-slate-700 pt-2">
                                                    <span>é ä¼°ç¢³è²»</span>
                                                    <span>+ ${fee}</span>
                                                </div>
                                            )}
                                        </div>

                                        <button 
                                            onClick={() => !isLocked && handleBuyPart(selectedCategory, part)}
                                            disabled={isLocked}
                                            className={`w-full py-3 rounded-lg font-bold
                                            ${isLocked ? 'bg-slate-700 text-slate-500' : 'bg-blue-600 hover:bg-blue-500 text-white'}`}
                                        >
                                            {parts[selectedCategory]?.id === part.id ? 'å·²å®‰è£' : `ç ”ç™¼ä¸¦å®‰è£ ($${part.cost + fee})`}
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            if (screen === 'MARKET') {
                return (
                    <div className="w-full h-full bg-slate-900 flex">
                        {currentTask && <ConstructionOverlay task={currentTask} />}
                        <div className="w-1/3 bg-slate-800 p-8 flex flex-col justify-between border-r border-slate-700">
                            <div>
                                <button onClick={() => setScreen('RESEARCH')} className="flex items-center gap-2 text-gray-400 hover:text-white mb-8">
                                    <ArrowLeft /> è¿”å›ç ”ç™¼ä¸­å¿ƒ
                                </button>
                                <h2 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 mb-4">
                                    å¸‚é›†
                                </h2>
                                <p className="text-gray-400">
                                    æŠ•è³‡æ¸›ç¢³æŠ€è¡“å¯æå‡æ’æ”¾ä¸Šé™ä¸¦è§£é–é«˜ç§‘æŠ€ç ”ç™¼ã€‚è³¼è²·é¡åº¦ä»¥æ‡‰å°é«˜ç¢³æ’éœ€æ±‚ã€‚
                                </p>
                            </div>
                            <div className="bg-slate-900 p-6 rounded-xl border border-slate-700">
                                <div className="text-gray-500 mb-2">ç•¶å‰æŒæœ‰è³‡é‡‘</div>
                                <div className="text-4xl font-mono text-yellow-400 mb-4">${money}</div>
                                <div className="text-gray-500 mb-2">æ’æ”¾ç¸½é‡ä¸Šé™</div>
                                <div className="text-4xl font-mono text-green-400">{carbonLimit}</div>
                            </div>
                        </div>

                        <div className="flex-1 p-8 grid grid-cols-2 gap-6 content-center">
                            {/* Market Actions */}
                            <div className="col-span-2 bg-slate-800 p-6 rounded-xl border-2 border-indigo-500/50 flex items-center justify-between hover:border-indigo-400 transition-colors group">
                                <div className="flex items-center gap-4">
                                    <div className="p-4 bg-indigo-900/50 rounded-lg text-indigo-400 group-hover:bg-indigo-500 group-hover:text-black transition-colors">
                                        <Factory size={32} />
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-bold">æŠ•è³‡æ¸›ç¢³æŠ€è¡“ (é—œéµ)</h3>
                                        <p className="text-sm text-gray-400">å¢åŠ æ’æ”¾ä¸Šé™ï¼Œä¸¦è§£é–ç ”ç™¼ä¸­å¿ƒçš„æŠ€è¡“å‡ç´šæ¬Šé™ã€‚</p>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => handleMarketAction('INVEST_TECH')} 
                                    disabled={hasInvestedInMarket}
                                    className={`px-6 py-2 rounded-lg font-bold border 
                                    ${hasInvestedInMarket ? 'bg-slate-700 text-gray-500 border-slate-600' : 'bg-indigo-600 hover:bg-indigo-500 text-white border-indigo-400'}`}
                                >
                                    {hasInvestedInMarket ? 'å·²æŠ•è³‡' : '-$1000'}
                                </button>
                            </div>

                            <div className="bg-slate-800 p-6 rounded-xl border border-slate-600 flex items-center justify-between hover:border-green-400 transition-colors group">
                                <div className="flex items-center gap-4">
                                    <div className="p-4 bg-green-900/50 rounded-lg text-green-400 group-hover:bg-green-500 group-hover:text-black transition-colors">
                                        <Leaf size={32} />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-bold">ç’°ä¿è¡Œå‹•</h3>
                                        <p className="text-xs text-gray-400">èŠ±è²»æ™‚é–“å¢åŠ å°‘é‡é¡åº¦ã€‚</p>
                                    </div>
                                </div>
                                <button onClick={() => handleMarketAction('ECO_ACTION')} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-bold border border-slate-500 text-sm">
                                    å…è²» (+1000)
                                </button>
                            </div>

                            <div className="bg-slate-800 p-6 rounded-xl border border-slate-600 flex items-center justify-between hover:border-blue-400 transition-colors group">
                                <div className="flex items-center gap-4">
                                    <div className="p-4 bg-blue-900/50 rounded-lg text-blue-400 group-hover:bg-blue-500 group-hover:text-black transition-colors">
                                        <TrendingUp size={32} />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-bold">è³¼è²·ç¢³æ¬Š</h3>
                                        <p className="text-xs text-gray-400 flex items-center gap-2">
                                            ç•¶å‰å¸‚åƒ¹: <span className="text-yellow-400 font-mono">${FIXED_BUY_PRICE}</span>
                                        </p>
                                    </div>
                                </div>
                                <button onClick={() => handleMarketAction('BUY_LIMIT')} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-sm">
                                    è³¼è²· (+5000)
                                </button>
                            </div>

                            <div className="col-span-2 bg-slate-800 p-6 rounded-xl border border-slate-600 flex items-center justify-between hover:border-yellow-400 transition-colors group">
                                <div className="flex items-center gap-4">
                                    <div className="p-4 bg-yellow-900/50 rounded-lg text-yellow-400 group-hover:bg-yellow-500 group-hover:text-black transition-colors">
                                        <Coins size={32} />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-bold">è²©è³£ç¢³æ¬Š</h3>
                                        <p className="text-xs text-gray-400">å”®åƒ¹ç‚ºå¸‚åƒ¹çš„ 60%ã€‚</p>
                                    </div>
                                </div>
                                <button onClick={() => handleMarketAction('SELL_LIMIT')} className="px-6 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-black text-sm">
                                    è²©è³£ (+${FIXED_SELL_PRICE})
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'ENDING') {
                const isGoodEnding = totalCarbon <= carbonLimit;
                
                return (
                    <div className={`w-full h-full flex flex-col items-center justify-center relative overflow-hidden transition-all duration-1000
                        ${isGoodEnding ? 'bg-sky-200' : 'bg-orange-900'}`}>
                        
                        <div className="absolute inset-0 z-0 opacity-50">
                            {isGoodEnding ? (
                                <div className="w-full h-full bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] flex items-end justify-center">
                                    <div className="w-full h-1/3 bg-green-500 rounded-t-[50%] blur-3xl opacity-60"></div>
                                </div>
                            ) : (
                                <div className="w-full h-full bg-[url('https://www.transparenttextures.com/patterns/grunge-wall.png')] flex items-end justify-center">
                                    <div className="w-full h-full bg-black/60"></div>
                                    <div className="absolute bottom-0 w-full h-1/2 bg-gray-900 blur-xl"></div>
                                </div>
                            )}
                        </div>

                        <div className="z-10 text-center space-y-6 max-w-2xl bg-black/40 backdrop-blur-md p-12 rounded-3xl border border-white/20 shadow-2xl">
                            <h1 className={`text-6xl font-black mb-4 ${isGoodEnding ? 'text-green-400' : 'text-red-500'}`}>
                                {isGoodEnding ? 'ç’°å¢ƒå…±å¥½çµå±€' : 'ç¢³æ’éé‡çµå±€'}
                            </h1>
                            
                            <p className="text-xl text-white">
                                {isGoodEnding 
                                    ? 'æ‚¨çš„é£›è¡Œå™¨æˆåŠŸå‡ç©ºï¼Œä¸¦ä¸”æœ‰æ•ˆåœ°æ§åˆ¶äº†ç¢³æ’æ”¾ã€‚ä¸–ç•Œå› ç‚ºæ‚¨çš„åŠªåŠ›è€Œè®Šå¾—æ›´åŠ ç¿ ç¶ ç”Ÿæ©Ÿï¼' 
                                    : 'é›–ç„¶é£›è¡Œå™¨å‡ç©ºäº†ï¼Œä½†éåº¦çš„ç¢³æ’æ”¾å°è‡´å¤©ç©ºç°æš—ï¼Œä¸–ç•Œé™·å…¥äº†å»¢åœŸèˆ‡æ±¡æŸ“ä¹‹ä¸­...'}
                            </p>
                            
                            <div className="grid grid-cols-2 gap-4 text-left bg-black/30 p-4 rounded-xl">
                                <div>æœ€çµ‚ç¢³æ’: <span className="font-bold">{totalCarbon}</span></div>
                                <div>æ’æ”¾ä¸Šé™: <span className="font-bold">{carbonLimit}</span></div>
                                <div className="col-span-2 text-center text-sm opacity-70 mt-2">
                                    {isGoodEnding ? 'åˆ¤å®šï¼šåˆæ ¼' : 'åˆ¤å®šï¼šè¶…æ¨™ (éœ€ç¹³ç´é‰…é¡ç¢³è²»)'}
                                </div>
                            </div>

                            <button onClick={() => setScreen('GALLERY')} className="px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition-transform">
                                æ”¶å…¥é£›èˆ¹æ”¶è—åº«
                            </button>
                        </div>
                    </div>
                );
            }

            if (screen === 'GALLERY') {
                return (
                    <div className="w-full h-full bg-slate-900 p-8 flex flex-col items-center">
                        <h2 className="text-3xl font-bold mb-8 text-white">é£›èˆ¹æ”¶è—åº«</h2>
                        
                        <div className="bg-slate-800 p-12 rounded-2xl border-2 border-slate-600 shadow-2xl flex flex-col items-center gap-6 w-full max-w-2xl">
                            <div className="w-full h-64 bg-slate-900 rounded-xl flex items-center justify-center border border-slate-700 relative overflow-hidden">
                                <div className="absolute inset-0 opacity-20 bg-[radial-gradient(circle,_var(--tw-gradient-stops))] from-blue-900 to-transparent"></div>
                                <ShipPreview parts={parts} />
                            </div>
                            
                            <div className="text-center">
                                <h3 className="text-2xl font-bold text-white mb-2">è©¦ä½œå‹é£›è¡Œå™¨ Mk-1</h3>
                                <div className="flex gap-4 text-sm text-gray-400 justify-center">
                                    <span>å¼•æ“: {parts.engine?.name}</span>
                                    <span>æ©Ÿèº«: {parts.body?.name}</span>
                                    <span>æ©Ÿç¿¼: {parts.wing?.name}</span>
                                </div>
                                {parts.decoration && (
                                    <div className="text-xs text-yellow-400 mt-2">
                                        â˜… æ­è¼‰: {parts.decoration.name}
                                    </div>
                                )}
                            </div>
                        </div>

                        <button onClick={handleReset} className="mt-12 px-8 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg flex items-center gap-2">
                            <ArrowLeft size={20}/> è¿”å›æ¨™é¡Œç•«é¢
                        </button>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>